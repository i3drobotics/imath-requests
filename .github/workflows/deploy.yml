name: Deployment

# Only trigger on main branch pull request close events
# used to deploy code after merging
# Versioning is automatically generated when merging, this is created by detecting the branch prefix:
# - 'major/' prefix for major release (e.g. N.x.x)
# - 'minor/' prefix for minor release (e.g. x.N.x)
# - no prefix for patch release (e.g. x.x.N)
on:
  pull_request:
    branches: [ main ]
    types: [ closed ]

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    environment: production
    steps:
      # Wait on other deployments to avoid collisions
      - name: Turnstyle
        uses: softprops/turnstyle@v1
        with:
          # bail on running immediately if busy
          abort-after-seconds: 1
        env:
          GITHUB_TOKEN: ${{ github.token }}
      # Checkout code
      - uses: actions/checkout@v2
      # Setup python
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.x"
      # Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install setuptools wheel twine sphinx sphinx-rtd-theme
          sudo apt-get install python3-sphinx
      # Get git variables
      - name: Get commit variables
        id: commit-vars
        shell: bash
        run: |
          echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
          echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"
      # Get latest released version
      - uses: oprypin/find-latest-tag@v1
        with:
          repository: i3drobotics/imath-requests  # The repository to scan.
          releases-only: true  # All relevant tags have a GitHub release for them.
        id: latest-tag  # The step ID to refer to later.
      # Get release type
      - name: Set default release type # Set default to patch if no prefix is recognised
        shell: bash
        run: echo "RELEASE_TYPE=patch" >> $GITHUB_ENV
      - name: Release type is major # If contains prefix major/xxx
        if: startsWith( github.head_ref, 'major')
        shell: bash
        run: echo "RELEASE_TYPE=major" >> $GITHUB_ENV
      - name: Release type is minor # If contains prefix minor/xxx or feature/xxx
        if: ${{ startsWith( github.head_ref, 'minor') || startsWith( github.head_ref, 'feature') }}
        shell: bash
        run: echo "RELEASE_TYPE=minor" >> $GITHUB_ENV
      - name: Release type is patch # If contains prefix patch/xxx, bugfix/xxx
        if: ${{ startsWith( github.head_ref, 'patch') || startsWith( github.head_ref, 'bugfix') }}
        shell: bash
        run: echo "RELEASE_TYPE=patch" >> $GITHUB_ENV
      # Generate new release version
      - name: Generate new version
        uses: actions-ecosystem/action-bump-semver@v1
        id: bump-version
        with:
          current_version: ${{ steps.latest-tag.outputs.tag }}
          level: ${{ env.RELEASE_TYPE }}
      # Add generated version to VERSION file
      - name: Add to Version file
        shell: bash
        run: |
          echo "${{ steps.bump-version.outputs.new_version }}" > version.template
      # Build
      - name: Build
        run: python setup.py sdist bdist_wheel
      # Publish to pip
      - name: Publish pip
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: twine upload --repository pypi dist/*
      # Create GitHub release
      - name: GitHub release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          body_path: release.md
          tag_name: ${{ steps.bump-version.outputs.new_version }}
          files: |
            dist/*
      # Generate docs using Sphinx
      - name: Docs
        run: |
          python -m pip install dist/*.whl
          cd docs
          make html
      # Deploy docs
      - name: Deploy docs
        uses: JamesIves/github-pages-deploy-action@4.1.7
        with:
          branch: docs
          folder: docs/_build/html
      # Merge branch into production
      - name: Merge main -> prod
        uses: devmasx/merge-branch@master
        with:
          type: now
          target_branch: prod
          github_token: ${{ github.token }}
          message: merged ${{ steps.commit-vars.outputs.sha_short }}
      # Merge main back to production
      - name: Merge prod -> main
        uses: devmasx/merge-branch@master
        with:
          type: now
          from_branch: prod
          target_branch: main
          github_token: ${{ github.token }}
          message: merged ${{ steps.commit-vars.outputs.sha_short }}
